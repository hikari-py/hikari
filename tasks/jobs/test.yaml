# Copyright Â© Nekoka.tt 2019
#
# This file is part of Hikari.
#
# Hikari is free software: you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Hikari is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with Hikari. If not, see <https://www.gnu.org/licenses/>.

.test:
    extends: .cache_merge_job
    allow_failure: false
    stage: test
    script:
        - source tasks/config.sh
        - python -V
        - apt-get update -q
        - apt-get install -qy git gcc g++ make
        - pip install poetry nox virtualenv
        - mkdir public || true
        # Run the pipelines.
        - echo -e "\e[1;33mRUNNING TEST PIPELINES\e[0m"
        - poetry install
        - poetry show -v
        - poetry run nox -spytest
        - poetry run nox -sbandit
        - poetry run nox -spypitest
        - poetry run nox -sformat_check || echo -e '\e[1;31mFix your formatting, yo!\e[0m Run `black hikari tests` and push again :-)'
    artifacts:
        paths:
            - public/coverage/
    coverage: /^TOTAL[\s\d%]+\s(\d+(?:\.\d+)?\%)$/

###
### TEST IN PYTHON 3.7
###
py37:
    image: python:3.7
    extends: .test

###
### TEST IN PYTHON 3.8
###
py38:
    image: python:3.8
    extends: .test
