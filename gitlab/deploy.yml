# Copyright Â© Nekoka.tt 2019-2020
#
# This file is part of Hikari.
#
# Hikari is free software: you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Hikari is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with Hikari. If not, see <https://www.gnu.org/licenses/>.

.deploy:
  allow_failure: false
  stage: deploy
  image: python:3.8.1
  before_script:
    - git log -n 1 "${CI_COMMIT_SHA}" --format="%B" | grep -iqE "\[\s*(skip|no|don'?t|do\s+not)\s+deploy(ments?)?\s*\]" && echo "SKIPPING ${CI_JOB_STAGE} STAGE JOB" && exit 0
    - source tasks/config.sh
    - apt-get update
    - apt-get install curl openssh-client -qy
    - bash tasks/retry_aborts.sh pip install twine wheel black
    - bash tasks/retry_aborts.sh pip install -e .

prerelease:
  extends: .deploy
  only:
    - staging
  except:
    - tags
    - merge_requests
    - schedules
  variables:
    RELEASE_WEBHOOK_NAME: "New development snapshot of the next release has been published"
    RELEASE_WEBHOOK_COLOUR: "0x2C2F33"
  script:
    - source tasks/deploy.sh
    - do-deployment
  environment:
    name: staging
    url: https://pypi.org/project/hikari/#history

release:
  extends: .deploy
  only:
    - master
  except:
    - tags
    - merge_requests
    - schedules
  variables:
    RELEASE_WEBHOOK_NAME: "NEW VERSION OF HIKARI HAS BEEN RELEASED!"
    RELEASE_WEBHOOK_COLOUR: "0x7289DA"
  script:
    - source tasks/deploy.sh
    - do-deployment
  environment:
    name: prod
    url: https://pypi.org/project/hikari/
